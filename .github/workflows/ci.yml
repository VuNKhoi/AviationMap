name: AviationMap CI ğŸš€

# ğŸš¦ AviationMap CI runs on every PR!
on:
  pull_request:
    branches:
      - '*'

jobs:
  lint:
    name: Lint & Analyze Code ğŸ”
    runs-on: macos-latest
    steps:
      - name: Checkout code ğŸ“¦
        uses: actions/checkout@v4
      - name: Set up Flutter ğŸ’™
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Cache dependencies âš¡ï¸
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
      - name: Check code formatting ğŸ¨
        run: dart format --set-exit-if-changed .
      - name: Run Flutter Analyze ğŸ”
        run: flutter analyze

  test:
    name: Run All Tests ğŸ§ª
    runs-on: macos-latest
    needs: lint
    steps:
      - name: Checkout code ğŸ“¦
        uses: actions/checkout@v4
      - name: Set up Flutter ğŸ’™
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Cache dependencies âš¡ï¸
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
      - name: Install lcov
        run: brew install lcov
      - name: Run tests ğŸ§ª
        run: flutter test --coverage
      - name: Upload coverage report ğŸ“Š
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/lcov.info
      - name: Generate coverage summary ğŸ“
        run: |
          genhtml coverage/lcov.info --output-directory coverage/html
          echo "Coverage summary:" > coverage/summary.txt
          grep -m 1 'lines......:' coverage/html/index.html | sed 's/<[^>]*>//g' >> coverage/summary.txt
      - name: Upload coverage summary ğŸ“Š
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage/summary.txt

  build-android:
    name: Build Android APK ğŸ¤–
    runs-on: macos-latest
    needs: test
    steps:
      - name: Checkout code ğŸ“¦
        uses: actions/checkout@v4
      - name: Set up Flutter ğŸ’™
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Cache dependencies âš¡ï¸
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
      - name: Build APK ğŸ¤–
        run: flutter build apk --debug
      - name: Upload APK Artifact ğŸ“
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk

  build-ios:
    name: Build iOS Debug App ğŸ
    runs-on: macos-latest
    needs: test
    steps:
      - name: Checkout code ğŸ“¦
        uses: actions/checkout@v4
      - name: Set up Flutter ğŸ’™
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Cache dependencies âš¡ï¸
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
      - name: Build iOS Debug ğŸ
        run: flutter build ios --debug --no-codesign
  security-scan:
    name: Check for Outdated or Vulnerable Dependencies ğŸ”’
    runs-on: macos-latest
    steps:
      - name: Checkout code ğŸ“¦
        uses: actions/checkout@v4
      - name: Set up Flutter ğŸ’™
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Run pub outdated ğŸ”’
        run: flutter pub outdated
      - name: Upload iOS Artifact ğŸ“
        uses: actions/upload-artifact@v4
        with:
          name: debug-ios
          path: build/ios/iphoneos

  notify:
    name: Email Pipeline Results ğŸ“§
    runs-on: macos-latest
    needs: [build-android, build-ios]
    steps:
      - name: Download coverage summary ğŸ“Š
        uses: actions/download-artifact@v4
        with:
          name: coverage-summary
          path: coverage
      - name: Send Email Notification ğŸ“§
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "AviationMap CI Results ğŸš¦"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            Hello AviationMap Team! ğŸ‰
            
            CI Pipeline completed for PR: ${{ github.event.pull_request.title }}
            
            Status: ${{ job.status }}
            
            Artifacts:
            - Android APK: ${{ steps.upload-apk.outputs.artifact-url }}
            - iOS Debug: ${{ steps.upload-ios.outputs.artifact-url }}
            
            Coverage Summary:
            $(cat coverage/summary.txt)
            
            Check the Actions tab for full logs and details!
            
            Have a great day! âœˆï¸
          secure: true
